<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MVR-Yhtymä Oy – Perehdytyslomake</title>
  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --bg-light: #f5f5f5;
      --bg-white: #fff;
      --text-dark: #333;
      --radius: 8px;
      --spacing: 16px;
    }
    html, body {
      margin: 0; padding: 0; overflow-x: hidden;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.5;
    }
    header {
      background: var(--bg-white);
      padding: var(--spacing);
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    header h1 {
      margin: 0; font-size: 2rem;
    }
    main {
      max-width: 900px; margin: var(--spacing) auto; padding: 0 var(--spacing);
    }
    section {
      background: var(--bg-white);
      margin-bottom: var(--spacing);
      padding: var(--spacing);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 0.25em;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--spacing);
    }
    @media (min-width: 600px) {
      .form-grid { grid-template-columns: 1fr 1fr; }
    }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: bold; margin-bottom: 0.5em; }
    input, select, textarea, button, canvas {
      font-size: 1rem;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      width: 100%; max-width: 100%;
    }
    input:invalid, select:invalid { border-color: red; }
    button {
      margin-top: var(--spacing);
      background: var(--primary-color);
      color: var(--bg-white);
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: var(--primary-hover); }
    .btn-group { display: flex; gap: var(--spacing); }
    .hidden { display: none; }
    ul { padding-left: 1em; margin: 0; }
    a { color: var(--primary-color); text-decoration: none; }
    a:hover { text-decoration: underline; }
    canvas.signature { border: 1px solid #ccc; cursor: crosshair; height: 200px; width: 100%; }
    #camera-modal {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(255,255,255,0.9);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 1000;
    }
    #camera-modal.hidden { display: none; }
    #camera-video {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; object-fit: cover;
    }
    .camera-overlay {
      position: absolute;
      top: 50%; left: 50%;
      width: 300px; height: 190px;
      margin-left: -150px; margin-top: -95px;
      box-shadow: 0 0 0 2000px rgba(255,255,255,0.8);
      border: 2px dashed var(--primary-color);
      border-radius: 8px;
    }
    .camera-controls {
      position: absolute; bottom: var(--spacing);
      display: flex; gap: var(--spacing);
    }
  </style>

  <!-- Google API + Gmail API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = '532156794647-r26r57kbpamkmvea5vtc6hdnjahjjqe0.apps.googleusercontent.com';
    const SCOPES = [
      'https://www.googleapis.com/auth/drive.file',
      'https://www.googleapis.com/auth/gmail.send'
    ].join(' ');
    const DISCOVERY_DOCS = [
      'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
      'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
    ];

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }
    async function initClient() {
      await gapi.client.init({
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      });
    }
    function ensureSignedIn() {
      const auth = gapi.auth2.getAuthInstance();
      if (!auth.isSignedIn.get()) {
        return auth.signIn();
      }
      return Promise.resolve();
    }

    async function uploadBlobToDrive(blob, filename) {
      await ensureSignedIn();
      const token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
      const metadata = { name: filename, mimeType: blob.type };
      const boundary = '-------314159265358979323846';
      const delim = "\r\n--" + boundary + "\r\n";
      const close = "\r\n--" + boundary + "--";
      const reader = new FileReader();
      return new Promise((resolve, reject) => {
        reader.onload = async () => {
          const base64Data = btoa(new Uint8Array(reader.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
          const multipart =
            delim + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
            JSON.stringify(metadata) +
            delim + 'Content-Type: ' + blob.type + '\r\n' +
            'Content-Transfer-Encoding: base64\r\n\r\n' + base64Data + close;
          try {
            const res = await fetch(
              'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=webViewLink',
              {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + token,
                  'Content-Type': 'multipart/related; boundary=' + boundary
                },
                body: multipart
              }
            );
            const json = await res.json();
            if (!res.ok) throw new Error('Drive API error: ' + JSON.stringify(json));
            resolve(json.webViewLink);
          } catch (e) {
            reject(e);
          }
        };
        reader.onerror = err => reject(err);
        reader.readAsArrayBuffer(blob);
      });
    }

    function makeEmailBody(to, cc, subject, htmlContent) {
      const headers = [
        `To: ${to}`,
        `Cc: ${cc}`,
        `Subject: ${subject}`,
        'Content-Type: text/html; charset=UTF-8',
        '',
        htmlContent
      ].join('\r\n');
      const encoded = btoa(unescape(encodeURIComponent(headers)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      return encoded;
    }

    async function sendEmail(to, cc, subject, htmlContent) {
      await ensureSignedIn();
      const raw = makeEmailBody(to, cc, subject, htmlContent);
      return gapi.client.gmail.users.messages.send({
        userId: 'me',
        resource: { raw }
      });
    }
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="handleClientLoad()"></script>
</head>
<body>
  <header>
    <h1>MVR-Yhtymä Oy</h1>
    <p>Perehdytyslomake – Bss + SKiB Kampus työmaa</p>
  </header>
  <main>
    <form id="orientationForm">
      <!-- Lomakekentät osioissa 1–12 kuten aiemmin -->
      <!-- ... -->
    </form>

    <div id="camera-modal" class="hidden">
      <video id="camera-video" autoplay playsinline></video>
      <div class="camera-overlay"></div>
      <div class="camera-controls">
        <button type="button" id="take-photo">Ota kuva</button>
        <button type="button" id="close-camera">Peruuta</button>
      </div>
    </div>
  </main>

  <script>
    // Signature pad, camera modal, drive upload kuten aiemmin
    // ...

    // Form submit: drive upload + Gmail send
    document.getElementById('orientationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      try {
        // Upload images
        const cardBlob = await new Promise(r => {/* capture cropBlob */});
        const cardUrl = await uploadBlobToDrive(cardBlob, 'valtti_' + Date.now() + '.jpg');

        const sigBlob = await new Promise(r => canvasSig.toBlob(r, 'image/jpeg', 0.7));
        const sigUrl = await uploadBlobToDrive(sigBlob, 'sig_' + Date.now() + '.jpg');

        // Build HTML email content
        const htmlContent = `
          <h1>Perehdytyslomake – BSS + SKiB Kampus</h1>
          <p><strong>Valtti-kortti:</strong> ${document.getElementById('valtti').value}</p>
          <p><strong>Korttikuvan linkki:</strong> <a href="${cardUrl}">${cardUrl}</a></p>
          <!-- Lisää muut lomaketiedot -->
          <p><strong>Allekirjoitus:</strong> <a href="${sigUrl}">${sigUrl}</a></p>
        `;
        const userEmail = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getEmail();

        await sendEmail(
          'kalle.uusitalo@mvr-yhtyma.fi',
          userEmail,
          'Perehdytyslomake täytetty',
          htmlContent
        );
        alert('Sähköposti lähetetty Gmail-kautta!');
      } catch (err) {
        console.error('Virhe:', err);
        alert('Lähetys epäonnistui: ' + (err.message || JSON.stringify(err)));
      }
    });
  </script>
</body>
</html>
