<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Perehdytyslomake</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estä sivun vieritys allekirjoitustilassa */
    #signature-pad.active {
      touch-action: none;
      overscroll-behavior: contain;
    }
  </style>
</head>
<body class="bg-gray-100 py-8">
  <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg space-y-8">
    <h1 class="text-3xl font-bold">MVR-Yhtymä Oy</h1>
    <h2 class="text-2xl font-semibold">Perehdytyslomake – Bss + SKiB Kampus työmaa</h2>

    <form id="send-form"
          action="https://script.google.com/macros/s/AKfycbx8HcZRpyKQLU3sxMBlj6irl09ZztFoSkLbTxImnTnTcSO5OaS-fiPKGraRKJtHpyYb_Q/exec"
          method="post"
          target="hidden_iframe"
          class="space-y-8">

      <!-- 1) VALTTI-kortti -->
      <fieldset class="border p-4 rounded space-y-2">
        <legend class="font-semibold">1. VALTTI-kortin numero (12 merkkiä)</legend>
        <input type="text" name="valttikortti" pattern="\d{12}"
               class="w-full border px-3 py-2 rounded"/>
      </fieldset>

      <!-- 2) Kuva (vapaaehtoinen) -->
      <fieldset class="border p-4 rounded space-y-2">
        <legend class="font-semibold">2. Ota tai lataa kuva (valinnainen)</legend>
        <div class="flex space-x-2">
          <button type="button" id="open-camera"
                  class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            Ota kamera
          </button>
          <label for="fileupload"
                 class="flex-1 py-2 bg-indigo-600 text-white text-center rounded hover:bg-indigo-700 cursor-pointer">
            Lataa tiedosto
          </label>
          <input type="file" id="fileupload" accept="image/*" class="hidden"/>
        </div>
        <div id="preview" class="border p-2 rounded min-h-[100px]"></div>
        <input type="hidden" name="filename"    id="filename"/>
        <input type="hidden" name="file"        id="file"/>
        <input type="hidden" name="imageformat" id="imageformat"/>
      </fieldset>

      <!-- 3) Allekirjoitus (pakollinen) -->
      <fieldset class="border p-4 rounded space-y-2">
        <legend class="font-semibold">3. Allekirjoitus (pakollinen)</legend>
        <div id="signature-pad" class="border rounded-lg relative">
          <canvas id="signature-canvas" class="w-full h-48"></canvas>
          <button type="button" id="clear-signature"
                  class="absolute top-2 right-2 bg-red-500 text-white px-3 py-1 rounded">
            Tyhjennä
          </button>
        </div>
        <input type="hidden" name="signature"         id="signature"/>
        <input type="hidden" name="signatureformat"   id="signatureformat" value="png"/>
        <input type="hidden" name="signaturefilename" id="signaturefilename"/>
      </fieldset>

    </form>

    <button id="send-button" form="send-form" type="submit" disabled
            class="w-full py-3 bg-green-600 text-white rounded opacity-50 cursor-not-allowed">
      Lähetä lomake
    </button>

    <div id="status" class="mt-6 text-center text-lg text-gray-800 hidden"></div>
    <iframe name="hidden_iframe" id="hidden_iframe" class="hidden"></iframe>

    <!-- Kamera overlay -->
    <div id="camera-overlay"
         class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
      <div class="relative w-[300px] h-[190px] rounded-xl overflow-hidden bg-black ring-4 ring-white">
        <video id="video" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline></video>
      </div>
      <button id="capture-button"
              class="absolute bottom-20 bg-white text-black py-2 px-6 rounded-full shadow-lg">
        Ota kuva
      </button>
    </div>
  </div>

  <!-- Signature Pad kirjasto -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <script>
    // 1) Kamera/lataus
    const openBtn    = document.getElementById('open-camera');
    const fileupload = document.getElementById('fileupload');
    const overlay    = document.getElementById('camera-overlay');
    const video      = document.getElementById('video');
    const captureBtn = document.getElementById('capture-button');
    const preview    = document.getElementById('preview');
    const filenameI  = document.getElementById('filename');
    const fileI      = document.getElementById('file');
    const fmtI       = document.getElementById('imageformat');
    let stream;
    openBtn.addEventListener('click', async () => {
      overlay.classList.remove('hidden');
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:'environment', width:{ideal:3840}, height:{ideal:2160} }
      });
      video.srcObject = stream;
    });
    captureBtn.addEventListener('click', () => {
      const vh=video.videoHeight, vw=video.videoWidth, aspect=1.585;
      const h=vh, w=Math.floor(h*aspect), sx=Math.floor((vw-w)/2);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(video,sx,0,w,h,0,0,w,h);
      stream.getTracks().forEach(t=>t.stop());
      overlay.classList.add('hidden');
      handleDataURL(c.toDataURL('image/jpeg',0.8));
    });
    fileupload.addEventListener('change', () => {
      const f=fileupload.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=evt=>handleDataURL(evt.target.result); r.readAsDataURL(f);
    });
    function handleDataURL(dataURL){
      preview.innerHTML=`<img src="${dataURL}" class="rounded-lg shadow-md"/>`;
      const [hdr,b64]=dataURL.split(','), mime=hdr.match(/data:(image\/[A-Za-z]+);base64/)[1];
      const ext=mime.split('/')[1].toLowerCase();
      filenameI.value=`kuva_${Date.now()}.${ext}`;
      fileI.value=b64;
      fmtI.value=ext;
    }

    // 2) Signature Pad
    const canvasEl = document.getElementById('signature-canvas');
    const sigPadDiv = document.getElementById('signature-pad');
    const sigPad = new SignaturePad(canvasEl, { backgroundColor:'rgba(255,255,255,0)' });
    const clearBtn = document.getElementById('clear-signature');
    const sigInput = document.getElementById('signature');
    const sigName  = document.getElementById('signaturefilename');
    const sendBtn  = document.getElementById('send-button');
    const statusDiv= document.getElementById('status');
    const form     = document.getElementById('send-form');
    let awaitingResponse = false;

    function resizeCanvas(){
      const ratio = Math.max(window.devicePixelRatio||1,1);
      canvasEl.width = canvasEl.offsetWidth * ratio;
      canvasEl.height= canvasEl.offsetHeight * ratio;
      canvasEl.getContext('2d').scale(ratio,ratio);
      sigPad.clear();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    clearBtn.addEventListener('click', ()=>{
      sigPad.clear();
      sigInput.value = '';
      checkFormReady();
    });
    sigPad.onEnd = checkFormReady;

    function checkFormReady(){
      const ready = !sigPad.isEmpty();
      if(ready){
        const dataURL = sigPad.toDataURL('image/png');
        sigInput.value = dataURL.split(',')[1];
        sigName.value  = `signature_${Date.now()}.png`;
      }
      sendBtn.disabled = !ready;
      sendBtn.classList.toggle('opacity-50', !ready);
      sendBtn.classList.toggle('cursor-not-allowed', !ready);
      sigPadDiv.classList.toggle('active', ready);
    }

    // 3) Submission & response
    form.addEventListener('submit', ()=>{
      awaitingResponse = true;
      statusDiv.textContent = 'Lähetetään…';
      statusDiv.classList.remove('hidden','error');
    });
    window.addEventListener('message', event=>{
      if(!awaitingResponse) return;
      awaitingResponse = false;
      const res = event.data;
      if(res.error){
        statusDiv.textContent = 'Virhe: '+res.error;
        statusDiv.classList.add('error');
      } else {
        statusDiv.textContent = 'Kiitos! Lomake lähetetty onnistuneesti.';
      }
      setTimeout(()=>location.reload(),5000);
    });
  </script>
</body>
</html>
