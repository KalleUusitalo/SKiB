<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ota ja lähetä kuva</title>
  <style>
    body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#f8f9fa;
           display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .container { background:#fff; padding:2rem; border-radius:.75rem;
                 box-shadow:0 4px 16px rgba(0,0,0,0.05); max-width:420px; width:90%; }
    h1 { margin:0 0 1.5rem; font-size:1.75rem; text-align:center; color:#333; }
    .input-group { margin-bottom:1.25rem; }
    label { display:block; margin-bottom:.5rem; color:#555; font-size:.9rem; }
    input[type="file"] { width:100%; padding:.5rem; border:1px solid #ced4da;
                         border-radius:.375rem; cursor:pointer; }
    #preview img { display:block; max-width:100%; margin-top:1rem; border-radius:.375rem; }
    button { width:100%; padding:.75rem; font-size:1rem; font-weight:500; color:#fff;
             background:linear-gradient(135deg,#0069d9,#0053ba); border:none;
             border-radius:.5rem; cursor:pointer; transition:background .2s,transform .1s; }
    button:hover { background:linear-gradient(135deg,#0053ba,#0041a8); transform:translateY(-1px); }
    button:active { transform:translateY(0); }
    #status { margin-top:1rem; text-align:center; font-size:.95rem; color:#28a745; }
    #status.error { color:#dc3545; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ota ja lähetä kuva</h1>
    <form id="photo-form"
          action="https://script.google.com/macros/s/AKfycbzZ8l6UOQV05ZNX-xrCeNUxxqLaAHY1PnsG9kckp70VcQuyTBAmdVJqub5W2at4khZ5GQ/exec"
          method="post"
          target="hidden_iframe">
      <div class="input-group">
        <label for="photo">Valitse tiedosto tai ota kuva:</label>
        <input type="file"
               id="photo"
               name="unused"
               accept="image/*"
               capture="environment"
               required>
      </div>
      <!-- Piilotetut kentät Base64-datalle -->
      <input type="hidden" name="filename"     id="filename">
      <input type="hidden" name="file"         id="file">
      <input type="hidden" name="imageformat"  id="imageformat">
      <div id="preview"></div>
      <button type="submit">Lähetä</button>
    </form>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
    <div id="status"></div>
  </div>

  <script>
    const form    = document.getElementById('photo-form');
    const input   = document.getElementById('photo');
    const preview = document.getElementById('preview');
    const status  = document.getElementById('status');
    const iframe  = document.getElementById('hidden_iframe');

    // Esikatselu
    input.addEventListener('change', () => {
      preview.innerHTML = '';
      const file = input.files[0];
      if (!file) return;
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);
    });

    // Käsittele Base64 ja lähetä
    form.addEventListener('submit', e => {
      e.preventDefault();
      const fileObj = input.files[0];
      if (!fileObj) {
        status.textContent = 'Valitse ensin kuva.';
        status.classList.add('error');
        return;
      }
      status.textContent = 'Käsitellään…';
      status.classList.remove('error');
      const reader = new FileReader();
      reader.onload = evt => {
        const [meta, base64] = evt.target.result.split(',');
        const mime = meta.match(/data:(image\/[a-zA-Z]+);base64/)[1];
        const ext  = mime.split('/')[1].toLowerCase();
        document.getElementById('filename').value    = fileObj.name;
        document.getElementById('file').value        = base64;
        document.getElementById('imageformat').value = ext;
        form.submit();  // piilotettuun iframeen
        status.textContent = 'Lähetetään…';
      };
      reader.readAsDataURL(fileObj);
    });

    // Kun iframe on latautunut, luetaan JSON-vastaus
    iframe.addEventListener('load', () => {
      let doc  = iframe.contentDocument || iframe.contentWindow.document;
      let text = doc.body.textContent;
      try {
        const res = JSON.parse(text);
        if (res.error) {
          status.textContent = 'Virhe: ' + res.error;
          status.classList.add('error');
        } else {
          status.innerHTML = 'Kiitos! '
            + 'Kuva tallennettu <a href="' + res.url + '" target="_blank">Drivessa</a>.';
          status.classList.remove('error');
        }
      } catch (err) {
        status.textContent = 'Vastaanotto epäonnistui.';
        status.classList.add('error');
      }
    });
  </script>
</body>
</html>
